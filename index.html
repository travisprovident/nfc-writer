<!DOCTYPE html>
<html>
<head>
  <title>NFC Tag Writer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; }
    input, button, textarea, select {
      margin-top: 0.5rem;
      display: block;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #status { margin-top: 1rem; font-weight: bold; }
    #resetBtn { background-color: #eee; margin-bottom: 1rem; }
    #cancelScanBtn {
      display: none;
      background-color: #fdd;
      color: black;
      font-weight: bold;
    }
    #assetNavInfo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <button id="resetBtn">üîÑ Reset NFC Session</button>

  <h2>NFC Tag Writer</h2>

  <label>Base URL</label>
  <input id="baseUrl" type="text" value="https://tinyurl.com/yr4c8nfc?id=">

  <label>Asset ID List (one per line)</label>
  <textarea id="assetList" rows="5" placeholder="123\n124\n125"></textarea>

  <button id="startBatch">Start Batch</button>

  <div id="batchControls" style="display:none;">
    <div id="assetNavInfo">
      <p><strong>Current Asset:</strong> <span id="currentAsset"></span></p>
      <p id="assetCountDisplay" style="font-size: 0.9rem; color: #555;"></p>
    </div>
    <button id="writeBtn">Write Tag</button>
    <button id="cancelScanBtn">‚ùå Cancel Scan</button>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
      <button id="prevBtn">‚¨ÖÔ∏è Previous</button>
      <button id="nextBtn">Next ‚û°Ô∏è</button>
    </div>
  </div>

  <div id="status"></div>
  <audio id="successSound" src="ding.mp3" preload="auto"></audio>

  <script>
    const baseUrlInput = document.getElementById("baseUrl");
    const assetListInput = document.getElementById("assetList");
    const writeBtn = document.getElementById("writeBtn");
    const cancelScanBtn = document.getElementById("cancelScanBtn");
    const status = document.getElementById("status");
    const successSound = document.getElementById("successSound");
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");

    let batchAssets = [], index = 0;
    let isScanCanceled = false;

    document.getElementById("resetBtn").onclick = () => location.reload();

    document.getElementById("startBatch").onclick = () => {
      batchAssets = assetListInput.value.trim().split("\n").map(id => id.trim().toUpperCase()).filter(Boolean);
      if (!batchAssets.length) {
        status.textContent = "‚ùó Enter at least one asset ID.";
        return;
      }
      index = 0;
      document.getElementById("batchControls").style.display = "block";
      updateDisplay();
    };

    function updateDisplay() {
      const id = batchAssets[index];
      document.getElementById("currentAsset").textContent = id;
      document.getElementById("assetCountDisplay").textContent = `Asset ${index + 1} of ${batchAssets.length}`;
    }

    nextBtn.onclick = () => {
      if (index < batchAssets.length - 1) index++;
      updateDisplay();
      status.textContent = "";
    };

    prevBtn.onclick = () => {
      if (index > 0) index--;
      updateDisplay();
      status.textContent = "";
    };

    cancelScanBtn.onclick = async () => {
      isScanCanceled = true;
      cancelScanBtn.style.display = "none";
      writeBtn.disabled = true;
      writeBtn.textContent = "Canceling...";
      status.textContent = "‚ùå Scan canceled. Resetting NFC...";

      await new Promise(r => setTimeout(r, 2000)); // Let Chrome reset

      writeBtn.disabled = false;
      writeBtn.textContent = "Write Tag";
      nextBtn.disabled = false;
      prevBtn.disabled = false;
      status.textContent = "Ready for next scan.";
    };

    writeBtn.onclick = async () => {
      const base = baseUrlInput.value.trim();
      const assetId = batchAssets[index];
      const fullUrl = base + assetId;

      isScanCanceled = false;
      cancelScanBtn.style.display = "inline-block";
      writeBtn.disabled = true;
      writeBtn.textContent = "Scanning...";
      nextBtn.disabled = true;
      prevBtn.disabled = true;

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        await new Promise(r => setTimeout(r, 250));

        if (isScanCanceled) {
          await new Promise(r => setTimeout(r, 500)); // short cooldown
          return;
        }

        await ndef.write({ records: [{ recordType: "url", data: fullUrl }] });
        await new Promise(r => setTimeout(r, 300));
        successSound.play();
        status.textContent = `‚úÖ Tag written for asset ${assetId}`;
      } catch (err) {
        if (err.message.includes("push is canceled")) {
          status.textContent = "‚ùå Please wait for scanner to reset before trying again.";
        } else {
          status.textContent = `‚ùå ${err.message}`;
        }
      } finally {
        cancelScanBtn.style.display = "none";
        writeBtn.disabled = false;
        writeBtn.textContent = "Write Tag";
        nextBtn.disabled = false;
        prevBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
