<!DOCTYPE html>
<html>
<head>
  <title>NFC Writer - Single & Batch Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; }
    input, button, textarea, select {
      margin-top: 0.5rem;
      display: block;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #status { margin-top: 1rem; font-weight: bold; }
    .mode-section { display: none; margin-top: 1rem; }
    #resetBtn { background-color: #eee; margin-bottom: 1rem; }
    #assetNavInfo {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }
    .cancel-scan {
      display: none;
      background-color: #fdd;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <button id="resetBtn" type="button">üîÑ Reset NFC Session</button>

  <h2>NFC Tag Writer</h2>

  <label>Choose Mode:</label>
  <select id="modeSelect">
    <option value="single">Single Asset</option>
    <option value="batch">Batch Write</option>
  </select>

  <div id="singleMode" class="mode-section">
    <label>Choose Company:</label>
    <select id="companySelectSingle">
      <option value="">-- Select Company --</option>
      <option value="https://tinyurl.com/yr4c8nfc?id=">Provident Asset Tracker</option>
      <option value="https://tinyurl.com/2e88evx9?id=">Ideal Asset Tracker</option>
      <option value="https://tinyurl.com/2fc45ykf?id=">Alpha Asset Tracker</option>
      <option value="https://tinyurl.com/2cpxwvxn?id=">Ensign Asset Tracker</option>
      <option value="https://tinyurl.com/4c9r7ybn?id=">Other Asset Tracker</option>
    </select>
    <label>Base URL</label>
    <input id="baseUrlSingle" type="text" placeholder="Enter base URL" />
    <label>Asset ID</label>
    <input id="assetIdSingle" type="text" placeholder="Enter asset ID" />
    <button id="writeSingle" type="button">Write to NFC Tag</button>
    <button id="cancelScanSingle" class="cancel-scan">‚ùå Cancel Scan</button>
  </div>

  <div id="batchMode" class="mode-section">
    <label>Choose Company:</label>
    <select id="companySelectBatch">
      <option value="">-- Select Company --</option>
      <option value="https://tinyurl.com/yr4c8nfc?id=">Provident Asset Tracker</option>
      <option value="https://tinyurl.com/2e88evx9?id=">Ideal Asset Tracker</option>
      <option value="https://tinyurl.com/2fc45ykf?id=">Alpha Asset Tracker</option>
      <option value="https://tinyurl.com/2cpxwvxn?id=">Ensign Asset Tracker</option>
      <option value="https://tinyurl.com/4c9r7ybn?id=">Other Asset Tracker</option>
    </select>
    <label>Base URL</label>
    <input id="baseUrlBatch" type="text" placeholder="Enter base URL" />
    <label>Asset ID List (one per line)</label>
    <textarea id="assetList" rows="5" placeholder="123\n124\n125"></textarea>
    <button id="startBatch">Start Batch Write</button>

    <div id="batchControls" style="display:none;">
      <div id="assetNavInfo">
        <p><strong>Current Asset:</strong> <span id="currentAsset"></span></p>
        <p id="assetCountDisplay" style="font-size: 0.9rem; color: #555;"></p>
      </div>
      <button id="writeBatch">Write Tag for Current Asset</button>
      <button id="cancelScanBatch" class="cancel-scan">‚ùå Cancel Scan</button>
      <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        <button id="prevAsset">‚¨ÖÔ∏è Previous</button>
        <button id="nextAsset">Next ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div id="status"></div>
  <audio id="successSound" src="ding.mp3" preload="auto"></audio>

  <script>
    const modeSelect = document.getElementById("modeSelect");
    const singleMode = document.getElementById("singleMode");
    const batchMode = document.getElementById("batchMode");
    const successSound = document.getElementById("successSound");
    const status = document.getElementById("status");

    const cancelScanSingle = document.getElementById("cancelScanSingle");
    const cancelScanBatch = document.getElementById("cancelScanBatch");
    const nextAssetBtn = document.getElementById("nextAsset");
    const prevAssetBtn = document.getElementById("prevAsset");

    const companySelectSingle = document.getElementById("companySelectSingle");
    const companySelectBatch = document.getElementById("companySelectBatch");

    let failCount = 0;
    let batchAssets = [];
    let batchIndex = 0;

    modeSelect.addEventListener("change", () => {
      singleMode.style.display = modeSelect.value === "single" ? "block" : "none";
      batchMode.style.display = modeSelect.value === "batch" ? "block" : "none";
      status.textContent = "";
    });

    companySelectSingle.addEventListener("change", () => {
      const val = companySelectSingle.value;
      if (val) document.getElementById("baseUrlSingle").value = val;
    });

    companySelectBatch.addEventListener("change", () => {
      const val = companySelectBatch.value;
      if (val) document.getElementById("baseUrlBatch").value = val;
    });

    document.getElementById("resetBtn").addEventListener("click", () => location.reload());

    cancelScanBatch.onclick = () => {
      localStorage.setItem("restoreState", "true");
      localStorage.setItem("savedMode", "batch");
      localStorage.setItem("savedAssetList", document.getElementById("assetList").value);
      localStorage.setItem("savedBaseUrl", document.getElementById("baseUrlBatch").value);
      localStorage.setItem("savedIndex", batchIndex.toString());
      location.reload();
    };

    cancelScanSingle.onclick = () => {
      localStorage.setItem("restoreState", "true");
      localStorage.setItem("savedMode", "single");
      localStorage.setItem("savedBaseUrl", document.getElementById("baseUrlSingle").value);
      localStorage.setItem("savedSingleId", document.getElementById("assetIdSingle").value);
      location.reload();
    };

    window.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("restoreState") === "true") {
        const mode = localStorage.getItem("savedMode") || "single";
        modeSelect.value = mode;
        modeSelect.dispatchEvent(new Event("change"));

        if (mode === "batch") {
          const assetList = localStorage.getItem("savedAssetList");
          const baseUrl = localStorage.getItem("savedBaseUrl");
          const index = parseInt(localStorage.getItem("savedIndex"), 10);
          if (assetList) document.getElementById("assetList").value = assetList;
          if (baseUrl) document.getElementById("baseUrlBatch").value = baseUrl;
          batchAssets = assetList.split("\n").map(x => x.trim().toUpperCase()).filter(Boolean);
          batchIndex = isNaN(index) ? 0 : index;
          document.getElementById("batchControls").style.display = "block";
          updateCurrentAssetDisplay();
        } else {
          const baseUrl = localStorage.getItem("savedBaseUrl");
          const assetId = localStorage.getItem("savedSingleId");
          if (baseUrl) document.getElementById("baseUrlSingle").value = baseUrl;
          if (assetId) document.getElementById("assetIdSingle").value = assetId;
        }

        localStorage.clear();
        status.textContent = "‚úÖ NFC session reset. Ready to scan again.";
      }
    });

    async function safeWrite(url, scanBtn, mode) {
      scanBtn.disabled = true;
      if (mode === "batch") {
        nextAssetBtn.disabled = true;
        prevAssetBtn.disabled = true;
        cancelScanBatch.style.display = "inline-block";
      } else {
        cancelScanSingle.style.display = "inline-block";
      }

      scanBtn.textContent = "Scanning...";
      await new Promise(resolve => setTimeout(resolve, 250));

      try {
        const ndef = new NDEFReader();
        await ndef.write({ records: [{ recordType: "url", data: url }] });
        await new Promise(r => setTimeout(r, 500));
        successSound.play();
        failCount = 0;
        return true;
      } catch (err) {
        console.error("Write failed:", err);
        failCount++;
        status.textContent = `‚ùå ${err.message}`;
        if (failCount >= 2) status.textContent += " ‚ö†Ô∏è Try toggling NFC or restarting Chrome.";
        return false;
      } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = scanBtn.dataset.originalText;
        cancelScanSingle.style.display = "none";
        cancelScanBatch.style.display = "none";
        nextAssetBtn.disabled = false;
        prevAssetBtn.disabled = false;
      }
    }

    function updateCurrentAssetDisplay() {
      const currentId = batchAssets[batchIndex].toUpperCase();
      document.getElementById("currentAsset").textContent = currentId;
      document.getElementById("assetCountDisplay").textContent = `Asset ${batchIndex + 1} of ${batchAssets.length}`;
    }

    document.getElementById("writeSingle").addEventListener("click", async () => {
      const base = document.getElementById("baseUrlSingle").value.trim();
      const id = document.getElementById("assetIdSingle").value.trim().toUpperCase();
      if (!base || !id) return status.textContent = "‚ùó Missing base URL or asset ID.";
      const fullUrl = `${base}${id}`;
      const scanBtn = document.getElementById("writeSingle");
      scanBtn.dataset.originalText = "Write to NFC Tag";
      const success = await safeWrite(fullUrl, scanBtn, "single");
      if (success) status.textContent = `‚úÖ Tag written: ${base}${id}`;
    });

    document.getElementById("startBatch").addEventListener("click", () => {
      const list = document.getElementById("assetList").value.trim().split("\n").filter(l => l);
      if (list.length === 0) return status.textContent = "‚ùó Enter at least one asset ID.";
      batchAssets = list.map(id => id.trim().toUpperCase());
      batchIndex = 0;
      document.getElementById("batchControls").style.display = "block";
      updateCurrentAssetDisplay();
    });

    document.getElementById("writeBatch").addEventListener("click", async () => {
      const base = document.getElementById("baseUrlBatch").value.trim();
      const id = batchAssets[batchIndex].toUpperCase();
      if (!base || !id) return status.textContent = "‚ùó Missing base URL or asset ID.";
      const fullUrl = `${base}${id}`;
      const scanBtn = document.getElementById("writeBatch");
      scanBtn.dataset.originalText = "Write Tag for Current Asset";
      const success = await safeWrite(fullUrl, scanBtn, "batch");
      if (success) status.textContent = `‚úÖ Tag written for asset ${id}`;
    });

    document.getElementById("nextAsset").addEventListener("click", () => {
      if (batchIndex + 1 < batchAssets.length) {
        batchIndex++;
        updateCurrentAssetDisplay();
        status.textContent = "";
      } else {
        status.textContent = "‚úÖ All assets written.";
      }
    });

    document.getElementById("prevAsset").addEventListener("click", () => {
      if (batchIndex > 0) {
        batchIndex--;
        updateCurrentAssetDisplay();
        status.textContent = "";
      } else {
        status.textContent = "‚ö†Ô∏è At the beginning of the list.";
      }
    });

    document.addEventListener("click", () => {
      if (successSound.paused) successSound.play().then(() => successSound.pause()).catch(() => {});
    }, { once: true });

    modeSelect.dispatchEvent(new Event("change"));
  </script>
</body>
</html>
