<!DOCTYPE html>
<html>
<head>
  <title>Test NFC Writer with Cancel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    button, input, textarea { margin-top: 1rem; padding: 0.5rem; width: 100%; font-size: 1rem; }
    #cancelScanBtn { display: none; background-color: #fdd; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Batch NFC Writer (Test)</h2>

  <input id="baseUrl" type="text" placeholder="Base URL (e.g. https://tinyurl.com/...id=)" />
  <textarea id="assetList" rows="5" placeholder="One asset ID per line"></textarea>
  <button id="startBatch">Start Batch</button>

  <div id="batchSection" style="display:none;">
    <p><strong>Current Asset:</strong> <span id="currentAsset"></span></p>
    <button id="writeBtn">Write Tag</button>
    <button id="cancelScanBtn">❌ Cancel Scan</button>
    <div style="display: flex; gap: 0.5rem;">
      <button id="prev">⬅️ Prev</button>
      <button id="next">Next ➡️</button>
    </div>
  </div>

  <div id="status"></div>
  <audio id="successSound" src="ding.mp3" preload="auto"></audio>

  <script>
    const baseInput = document.getElementById("baseUrl");
    const assetList = document.getElementById("assetList");
    const currentAsset = document.getElementById("currentAsset");
    const writeBtn = document.getElementById("writeBtn");
    const cancelBtn = document.getElementById("cancelScanBtn");
    const status = document.getElementById("status");
    const successSound = document.getElementById("successSound");

    let batch = [], index = 0, isScanCanceled = false;

    document.getElementById("startBatch").onclick = () => {
      batch = assetList.value.trim().split("\n").map(id => id.trim().toUpperCase()).filter(Boolean);
      if (!batch.length) return alert("Enter at least one ID.");
      index = 0;
      update();
      document.getElementById("batchSection").style.display = "block";
    };

    function update() {
      currentAsset.textContent = batch[index] || "";
    }

    cancelBtn.onclick = () => {
      isScanCanceled = true;
      cancelBtn.style.display = "none";
      status.textContent = "❌ Scan canceled.";
    };

    document.getElementById("next").onclick = () => {
      if (index < batch.length - 1) index++;
      update();
      status.textContent = "";
    };

    document.getElementById("prev").onclick = () => {
      if (index > 0) index--;
      update();
      status.textContent = "";
    };

    writeBtn.onclick = async () => {
      isScanCanceled = false;
      cancelBtn.style.display = "inline-block";
      const base = baseInput.value.trim();
      const id = batch[index];
      if (!base || !id) return alert("Missing base URL or ID");
      const url = base + id;

      writeBtn.disabled = true;
      writeBtn.textContent = "Scanning...";
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        await new Promise(r => setTimeout(r, 250));
        if (isScanCanceled) return;
        await ndef.write({ records: [{ recordType: "url", data: url }] });
        successSound.play();
        status.textContent = `✅ Tag written: ${id}`;
      } catch (err) {
        status.textContent = `❌ Error: ${err.message}`;
      } finally {
        cancelBtn.style.display = "none";
        writeBtn.disabled = false;
        writeBtn.textContent = "Write Tag";
      }
    };
  </script>

</body>
</html>
